<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Student Dashboard</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="stylesheets/style.css">

    <script nonce="<%= nonce %>" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script nonce="<%= nonce %>" src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script nonce="<%= nonce %>" src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script nonce="<%= nonce %>"
        src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.10.2/underscore.min.js"></script>

</head>

<body>
    <div class="app-wrapper">
        <div class="page-bg-overlay">
            <div class="bg-grid"></div>
        </div>
        <%- include('partials/navbar-partial.ejs') %>

            <div class="container justify-content-center mt-3 py-4">
                <!-- Search Bar -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" id="searchInput" class="form-control"
                            placeholder="Search by university, department, major..."
                            style="background: rgba(255,255,255,0.7); border: 1px solid var(--border-color); border-radius: 10px;">
                    </div>
                    <div class="col-md-4">
                        <select id="filterUni" class="form-control"
                            style="background: rgba(255,255,255,0.7); border: 1px solid var(--border-color); border-radius: 10px;">
                            <option value="">All Universities</option>
                        </select>
                    </div>
                </div>

                <p class="text-muted small">Showing <span id="visibleCount">
                        <%= certData.length %>
                    </span> of <%= certData.length %> certificates</p>

                <% for(var i=0; i < certData.length; i++) { %>
                    <div class="row cert-container card cert-item" data-uni="<%= certData[i].universityName %>"
                        data-dept="<%= certData[i].departmentName %>" data-major="<%= certData[i].major %>">
                        <div class="col-sm-12 card-body ">
                            <% if (certData[i].revoked) { %>
                                <div class="alert mb-2"
                                    style="background: rgba(248, 81, 73, 0.15); border-color: rgba(248, 81, 73, 0.3); color: #f85149; padding: 6px 12px; font-size: 0.85rem;">
                                    ‚ö† This certificate has been REVOKED by the issuing university
                                </div>
                                <% } %>
                                    <% if (certData[i].expired) { %>
                                        <div class="alert mb-2"
                                            style="background: rgba(255, 193, 7, 0.15); border-color: rgba(255, 193, 7, 0.3); color: #ffc107; padding: 6px 12px; font-size: 0.85rem;">
                                            ‚è∞ This certificate has EXPIRED on <%= certData[i].expiryDate %>
                                        </div>
                                        <% } %>
                                            <div class="row text-center upper-row">
                                                <div class="col-sm-4 orange"> <strong>University<br></strong>
                                                    <%= certData[i].universityName %>
                                                </div>
                                                <div class="col-sm-4 orange"><strong>University Email <br></strong>
                                                    <%= certData[i].universityEmail %>
                                                </div>
                                                <div class="col-sm-4 orange"><strong>CGPA <br></strong>
                                                    <%= certData[i].cgpa %>
                                                </div>
                                            </div>
                                            <div class="row text-center middle-row">
                                                <div class="col-sm-4 orange"> <strong>Dept<br></strong>
                                                    <%= certData[i].departmentName %>
                                                </div>
                                                <div class="col-sm-4 orange"><strong>Date Of Issue<br></strong>
                                                    <%= certData[i].dateOfIssuing %>
                                                </div>
                                                <div class="col-sm-4 orange"><strong>Major <br></strong>
                                                    <%= certData[i].major %>
                                                </div>
                                            </div>
                                            <div class="row text-center bottom-row">
                                                <div class="col-sm-6 orange"> <strong>Certificate UUID <br></strong>
                                                    <small>
                                                        <%= certData[i].certUUID %>
                                                    </small>
                                                </div>
                                                <div class="col-sm-6 orange"><strong>Roll Number<br></strong>
                                                    <%= certData[i].rollNumber || 'N/A' %>
                                                </div>
                                            </div>

                                            <!-- Action Buttons -->
                                            <div class="row text-center mt-3">
                                                <!-- Row 1: Download & View -->
                                                <div class="col-sm-6 mb-2">
                                                    <a href="/student/certificate/download/<%= certData[i].certUUID %>"
                                                        class="btn btn-sm btn-outline-info btn-block">üì• Download
                                                        PDF</a>
                                                </div>
                                                <div class="col-sm-6 mb-2">
                                                    <% if (certData[i].certificateImage) { %>
                                                        <a href="<%= certData[i].certificateImage %>" target="_blank"
                                                            class="btn btn-sm btn-outline-success btn-block">üñº View
                                                            Original</a>
                                                        <% } else { %>
                                                            <span
                                                                class="btn btn-sm btn-outline-secondary btn-block disabled">No
                                                                Image</span>
                                                            <% } %>
                                                </div>

                                                <!-- Row 2: LinkedIn & Transcript -->
                                                <div class="col-sm-6 mb-2">
                                                    <button
                                                        class="btn btn-sm btn-outline-primary btn-block linkedin-btn"
                                                        data-name="Degree in <%= certData[i].major %>"
                                                        data-org="<%= certData[i].universityName %>"
                                                        data-date="<%= certData[i].dateOfIssuing %>"
                                                        data-uuid="<%= certData[i].certUUID %>">
                                                        üîó Add to LinkedIn
                                                    </button>
                                                </div>
                                                <div class="col-sm-6 mb-2">
                                                    <button class="btn btn-sm btn-outline-warning btn-block"
                                                        data-toggle="modal" data-target="#transcriptModal"
                                                        data-certid="<%= certData[i].certUUID %>"
                                                        data-uni="<%= certData[i].universityName %>">
                                                        üìú Request Transcript
                                                    </button>
                                                </div>

                                                <!-- Row 3: Share Certificate (Centered) -->
                                                <div class="col-sm-12 mt-2">
                                                    <button type="button" class="btn btn-primary btn-sm px-5"
                                                        style="border-radius: 20px;" data-toggle="modal"
                                                        data-target="#shareDataModal"
                                                        data-certid="<%= certData[i].certUUID %>">
                                                        Share Certificate
                                                    </button>
                                                </div>
                                            </div>
                        </div>
                    </div>
                    <% } %>




            </div>
            <div class="modal fade" id="shareDataModal" tabindex="-1" role="dialog"
                aria-labelledby="shareDataModalLabel">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="shareDataModalTitle">Share Certificate</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="shareForm">
                                <div class="form-check">
                                    <input name="universityName" class="form-check-input" type="checkbox" value="true"
                                        id="university-name">
                                    <label class="form-check-label" for="university-name">
                                        University Name
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input name="major" class="form-check-input" type="checkbox" value="true"
                                        id="major">
                                    <label class="form-check-label" for="major">
                                        Major
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input name="departmentName" class="form-check-input" type="checkbox" value="true"
                                        id="department-name">
                                    <label class="form-check-label" for="department-name">
                                        Department Name
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input name="cgpa" class="form-check-input" type="checkbox" value="true" id="cgpa">
                                    <label class="form-check-label" for="cgpa">
                                        CGPA
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button id="modalCreateProof" type="button" class="btn btn-primary"
                                data-dismiss="modal">Create
                                Proof</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Modal -->
            <div class="modal fade" id="shareSuccessModal" tabindex="-1" role="dialog"
                aria-labelledby="shareSuccessModalCenterTitle">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="shareSuccessModalTitle">Proof Generated. Copy Proof
                                Below.</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div id="shareSuccessModalBody" class="modal-body">

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="modal fade" id="shareFailModal" tabindex="-1" role="dialog"
                aria-labelledby="shareFailModalCenterTitle">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="shareFailModalTitle">Error Generating Proof.</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div id="shareFailModalBody" class="modal-body">
                            Failed to generate Proof.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Transcript Modal -->
            <div class="modal fade" id="transcriptModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Request Official Transcript</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form action="/student/request-transcript" method="POST">
                            <div class="modal-body">
                                <p>Request an official transcript from <strong id="transcriptUniName"></strong>?</p>
                                <p class="text-muted small">This will send an email notification to the university
                                    administrator.</p>
                                <input type="hidden" name="certId" id="transcriptCertId">
                                <div class="form-group">
                                    <label for="transcriptNote">Additional Note (Optional)</label>
                                    <textarea name="note" class="form-control" id="transcriptNote" rows="3"
                                        placeholder="e.g. Applying for Masters program..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-warning">Send Request</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
    </div>
    <%- include('partials/footer-partial.ejs') %>

        <script nonce="<%= nonce %>" src="/js/dashboardStudent.js"></script>
        <script nonce="<%= nonce %>">
            $(document).ready(function () {
                // Populate university filter
                var unis = new Set();
                $('.cert-item').each(function () {
                    var uni = $(this).data('uni');
                    if (uni) unis.add(uni);
                });
                unis.forEach(function (u) {
                    $('#filterUni').append('<option value="' + u + '">' + u + '</option>');
                });

                function applyFilters() {
                    var search = $('#searchInput').val().toLowerCase();
                    var uni = $('#filterUni').val().toLowerCase();
                    var visible = 0;

                    $('.cert-item').each(function () {
                        var u = $(this).data('uni').toString().toLowerCase();
                        var d = $(this).data('dept').toString().toLowerCase();
                        var m = $(this).data('major').toString().toLowerCase();

                        var matchSearch = !search || u.includes(search) || d.includes(search) || m.includes(search);
                        var matchUni = !uni || u === uni;

                        if (matchSearch && matchUni) {
                            $(this).show();
                            visible++;
                        } else {
                            $(this).hide();
                        }
                    });
                    $('#visibleCount').text(visible);
                }

                $('#searchInput').on('input', applyFilters);
                $('#filterUni').on('change', applyFilters);

                // LinkedIn Button Logic
                $('.linkedin-btn').click(function () {
                    var name = $(this).data('name');
                    var org = $(this).data('org');
                    var dateStr = $(this).data('date'); // YYYY-MM-DD
                    var uuid = $(this).data('uuid');

                    var dateParts = dateStr.split('-');
                    var year = dateParts[0];
                    var month = dateParts[1];

                    var url = 'https://www.linkedin.com/profile/add?startTask=CERTIFICATION_NAME&name=' + encodeURIComponent(name) +
                        '&organizationName=' + encodeURIComponent(org) +
                        '&issueYear=' + year +
                        '&issueMonth=' + month +
                        '&certUrl=' + encodeURIComponent(window.location.origin + '/verify/' + uuid) +
                        '&certId=' + uuid;

                    window.open(url, '_blank');
                });

                // Transcript Modal Logic
                $('#transcriptModal').on('show.bs.modal', function (event) {
                    var button = $(event.relatedTarget);
                    var certId = button.data('certid');
                    var uni = button.data('uni');
                    $('#transcriptCertId').val(certId);
                    $('#transcriptUniName').text(uni);
                });
            });
        </script>
        </div>
</body>

</html>