<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>University Dashboard</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="stylesheets/style.css">
</head>

<body>
    <div class="app-wrapper">
        <div class="page-bg-overlay">
            <div class="bg-grid"></div>
            <div class="bg-dots"></div>
        </div>

        <%- include('partials/navbar-partial.ejs') %>

            <div class="container justify-content-center py-4">


                <!-- Analytics Section -->
                <div class="row mb-4">
                    <div class="col-md-7">
                        <div class="card h-100">
                            <div
                                class="card-header d-flex flex-wrap justify-content-center justify-content-md-between align-items-center">
                                <span id="chartTitle" class="encoded-text">Certificates Issued (Last 6 Months)</span>
                                <select id="timeRange" class="form-control form-control-sm w-auto ml-2">
                                    <option value="6m">Last 6 Months</option>
                                    <option value="1y">Last 1 Year</option>
                                    <option value="2y">Last 2 Years</option>
                                    <option value="3y">Last 3 Years</option>
                                    <option value="lifetime">Lifetime</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <div id="customDateRange" class="d-none row w-100 mt-2 align-items-center no-gutters">
                                    <div class="col-6 col-sm-auto px-1">
                                        <input type="date" id="startDate"
                                            class="form-control form-control-sm my-2 w-100">
                                    </div>
                                    <div class="d-none d-sm-block col-sm-auto px-1 text-center">
                                        <span class="font-weight-bold" style="font-size: 1.2rem;">-</span>
                                    </div>
                                    <div class="col-6 col-sm-auto px-1">
                                        <input type="date" id="endDate" class="form-control form-control-sm my-2 w-100">
                                    </div>
                                    <div class="col-12 col-sm-auto text-center px-1">
                                        <button id="applyCustomDate"
                                            class="btn btn-sm btn-primary my-2 ml-sm-2">Apply</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="issuanceChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card h-100">
                            <div class="card-header">Department Distribution</div>
                            <div class="card-body">
                                <canvas id="deptChart" style="max-height: 250px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search & Filter Bar -->
                <div class="row mb-3 mt-3">
                    <div class="col-md-6">
                        <input type="text" id="searchInput" class="form-control"
                            placeholder="Search by student name, email, department..."
                            style="background: rgba(255,255,255,0.7); border: 1px solid var(--border-color); border-radius: 10px;">
                    </div>
                    <div class="col-md-3">
                        <select id="filterDept" class="form-control">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="filterStatus" class="form-control">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="revoked">Revoked</option>
                        </select>
                    </div>
                </div>

                <p class="text-muted small">Showing <span id="visibleCount">
                        <%= certData.length %>
                    </span> of <%= certData.length %> certificates</p>

                <% for(var i=0; i < certData.length; i++) { %>
                    <div class="row cert-container card cert-item" data-name="<%= certData[i].studentName %>"
                        data-email="<%= certData[i].studentEmail %>" data-dept="<%= certData[i].departmentName %>"
                        data-status="<%= certData[i].revoked ? 'revoked' : 'active' %>">
                        <div class="col-sm-12 card-body">
                            <% if (certData[i].revoked) { %>
                                <div class="alert mb-2"
                                    style="background: rgba(248, 81, 73, 0.15); border-color: rgba(248, 81, 73, 0.3); color: #f85149; padding: 6px 12px; font-size: 0.85rem;">
                                    âš  REVOKED <% if (certData[i].revokedReason) { %> â€” <%= certData[i].revokedReason %>
                                            <% } %>
                                </div>
                                <% } %>
                                    <div class="row text-center certificate-details-grid justify-content-center">
                                        <div class="col-6 col-md-4 orange"> <strong>Name <br></strong>
                                            <%= certData[i].studentName %>
                                        </div>
                                        <div class="col-6 col-md-4 orange"><strong>Email <br></strong>
                                            <%= certData[i].studentEmail %>
                                        </div>
                                        <div class="col-6 col-md-4 orange"><strong>CGPA <br></strong>
                                            <%= certData[i].cgpa %>
                                        </div>

                                        <div class="col-6 col-md-4 orange"> <strong>Dept<br></strong>
                                            <%= certData[i].departmentName %>
                                        </div>
                                        <div class="col-6 col-md-4 orange"><strong>Date Of Issue<br></strong>
                                            <%= certData[i].dateOfIssuing %>
                                        </div>
                                        <div class="col-6 col-md-4 orange"><strong>Major <br></strong>
                                            <%= certData[i].major %>
                                        </div>

                                        <div class="col-6 col-md-4 orange"> <strong>Roll No <br></strong>
                                            <%= certData[i].rollNumber || 'N/A' %>
                                        </div>
                                        <div class="col-6 col-md-4 orange"> <strong>UUID <br></strong> <small
                                                class="text-truncate d-block" style="max-width: 100%;">
                                                <%= certData[i].certUUID %>
                                            </small></div>
                                        <div class="col-6 col-md-4 orange"><strong>Hash<br></strong>
                                            <div class="d-flex justify-content-center align-items-center">
                                                <small class="hash-display mr-2">****</small>
                                                <button class="btn btn-sm btn-link p-0 toggle-hash"
                                                    data-full-hash="<%= certData[i].hash %>">
                                                    <i data-feather="eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-2">
                                        <div class="col-sm-4 mb-2 mb-sm-0">
                                            <a href="/university/certificate/download/<%= certData[i].certUUID %>"
                                                class="btn btn-sm btn-outline-info btn-block">ðŸ“¥ Download PDF</a>
                                        </div>
                                        <div class="col-sm-4 mb-2 mb-sm-0">
                                            <% if (certData[i].certificateImage) { %>
                                                <a href="<%= certData[i].certificateImage %>" target="_blank"
                                                    class="btn btn-sm btn-outline-success btn-block">ðŸ–¼ View Image</a>
                                                <% } else { %>
                                                    <span class="btn btn-sm btn-outline-secondary btn-block disabled">No
                                                        Image</span>
                                                    <% } %>
                                        </div>
                                        <div class="col-sm-4 mb-2 mb-sm-0">
                                            <% if (!certData[i].revoked) { %>
                                                <button class="btn btn-sm btn-outline-danger btn-block"
                                                    data-toggle="modal" data-target="#revokeModal"
                                                    data-certid="<%= certData[i].certUUID %>"
                                                    data-name="<%= certData[i].studentName %>">ðŸš« Revoke</button>
                                                <% } else { %>
                                                    <span
                                                        class="btn btn-sm btn-outline-secondary btn-block disabled">Revoked</span>
                                                    <% } %>
                                        </div>
                                    </div>
                        </div>
                    </div>
                    <% } %>

                        <!-- Revoke Modal -->
                        <div class="modal fade" id="revokeModal" tabindex="-1" role="dialog">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="revokeModalTitle">Revoke Certificate</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <form action="/university/revoke" method="POST">
                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                        <div class="modal-body">
                                            <p>Are you sure you want to revoke the certificate for <strong
                                                    id="revokeStudentName"></strong>?</p>
                                            <p class="text-muted small">This action cannot be undone.</p>
                                            <input type="hidden" name="certId" id="revokeCertId">
                                            <div class="form-group">
                                                <label for="revokeReason">Reason for Revocation</label>
                                                <textarea name="reason" class="form-control" id="revokeReason" rows="3"
                                                    placeholder="e.g. Fraudulent submission, Academic misconduct..."
                                                    required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-danger">Revoke Certificate</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

            </div>


            <script nonce="<%= nonce %>" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script nonce="<%= nonce %>"
                src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.10.2/underscore.min.js"
                crossorigin="anonymous"></script>
            <script nonce="<%= nonce %>" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script nonce="<%= nonce %>" src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
                crossorigin="anonymous"></script>
            <script nonce="<%= nonce %>" src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
                crossorigin="anonymous"></script>
            <script nonce="<%= nonce %>" src="/js/dashboardUniversity.js"></script>
            <script nonce="<%= nonce %>">
                $(document).ready(function () {
                    // Populate department filter
                    var depts = new Set();
                    $('.cert-item').each(function () {
                        var dept = $(this).data('dept');
                        if (dept) depts.add(dept);
                    });
                    depts.forEach(function (d) {
                        $('#filterDept').append('<option value="' + d + '">' + d + '</option>');
                    });

                    // Search & filter logic
                    function applyFilters() {
                        var search = $('#searchInput').val().toLowerCase();
                        var dept = $('#filterDept').val().toLowerCase();
                        var status = $('#filterStatus').val().toLowerCase();
                        var visible = 0;

                        $('.cert-item').each(function () {
                            var name = $(this).data('name').toString().toLowerCase();
                            var email = $(this).data('email').toString().toLowerCase();
                            var d = $(this).data('dept').toString().toLowerCase();
                            var s = $(this).data('status').toString().toLowerCase();

                            var matchSearch = !search || name.includes(search) || email.includes(search) || d.includes(search);
                            var matchDept = !dept || d === dept;
                            var matchStatus = !status || s === status;

                            if (matchSearch && matchDept && matchStatus) {
                                $(this).show();
                                visible++;
                            } else {
                                $(this).hide();
                            }
                        });
                        $('#visibleCount').text(visible);
                    }

                    $('#searchInput').on('input', applyFilters);
                    $('#filterDept').on('change', applyFilters);
                    $('#filterStatus').on('change', applyFilters);

                    // Revoke modal population
                    $('#revokeModal').on('show.bs.modal', function (event) {
                        var button = $(event.relatedTarget);
                        var certId = button.data('certid');
                        var name = button.data('name');
                        $('#revokeCertId').val(certId);
                        $('#revokeStudentName').text(name);
                    });
                });
            </script>
    </div>
    <!-- Hash Display Modal -->
    <div class="modal fade" id="hashModal" tabindex="-1" role="dialog" aria-labelledby="hashModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hashModalLabel">Certificate Hash</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-break p-4 bg-light rounded text-center">
                    <code id="modalHashText" class="text-dark font-weight-bold" style="font-size: 1.1em;"></code>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer-partial.ejs') %>
        </div>
</body>

</html>