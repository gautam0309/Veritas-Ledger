<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>University Dashboard</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
        integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="stylesheets/style.css">
</head>

<body>
    <%- include('partials/navbar-partial.ejs') %>

        <div class="container justify-content-center">

            <!-- Search & Filter Bar -->
            <div class="row mb-3 mt-3">
                <div class="col-md-6">
                    <input type="text" id="searchInput" class="form-control"
                        placeholder="Search by student name, email, department..."
                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(102,126,234,0.3); color: #fff;">
                </div>
                <div class="col-md-3">
                    <select id="filterDept" class="form-control"
                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(102,126,234,0.3); color: #fff;">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filterStatus" class="form-control"
                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(102,126,234,0.3); color: #fff;">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="revoked">Revoked</option>
                    </select>
                </div>
            </div>

            <p class="text-muted small">Showing <span id="visibleCount">
                    <%= certData.length %>
                </span> of <%= certData.length %> certificates</p>

            <% for(var i=0; i < certData.length; i++) { %>
                <div class="row cert-container card cert-item" data-name="<%= certData[i].studentName %>"
                    data-email="<%= certData[i].studentEmail %>" data-dept="<%= certData[i].departmentName %>"
                    data-status="<%= certData[i].revoked ? 'revoked' : 'active' %>">
                    <div class="col-sm-12 card-body">
                        <% if (certData[i].revoked) { %>
                            <div class="alert mb-2"
                                style="background: rgba(248, 81, 73, 0.15); border-color: rgba(248, 81, 73, 0.3); color: #f85149; padding: 6px 12px; font-size: 0.85rem;">
                                âš  REVOKED <% if (certData[i].revokedReason) { %> â€” <%= certData[i].revokedReason %>
                                        <% } %>
                            </div>
                            <% } %>
                                <div class="row text-center upper-row">
                                    <div class="col-sm-4 orange"> <strong>Name <br></strong>
                                        <%= certData[i].studentName %>
                                    </div>
                                    <div class="col-sm-4 orange"><strong>Email <br></strong>
                                        <%= certData[i].studentEmail %>
                                    </div>
                                    <div class="col-sm-4 orange"><strong>CGPA <br></strong>
                                        <%= certData[i].cgpa %>
                                    </div>
                                </div>
                                <div class="row text-center middle-row">
                                    <div class="col-sm-4 orange"> <strong>Dept<br></strong>
                                        <%= certData[i].departmentName %>
                                    </div>
                                    <div class="col-sm-4 orange"><strong>Date Of Issue<br></strong>
                                        <%= certData[i].dateOfIssuing %>
                                    </div>
                                    <div class="col-sm-4 orange"><strong>Major <br></strong>
                                        <%= certData[i].major %>
                                    </div>
                                </div>
                                <div class="row text-center bottom-row">
                                    <div class="col-sm-3 orange"> <strong>Roll No <br></strong>
                                        <%= certData[i].rollNumber || 'N/A' %>
                                    </div>
                                    <div class="col-sm-3 orange"> <strong>UUID <br></strong> <small>
                                            <%= certData[i].certUUID %>
                                        </small></div>
                                    <div class="col-sm-6 orange"><strong>Hash<br></strong> <small>
                                            <%= certData[i].hash %>
                                        </small></div>
                                </div>
                                <div class="row text-center mt-2">
                                    <div class="col-sm-4">
                                        <a href="/university/certificate/download/<%= certData[i].certUUID %>"
                                            class="btn btn-sm btn-outline-info btn-block">ðŸ“¥ Download PDF</a>
                                    </div>
                                    <div class="col-sm-4">
                                        <% if (certData[i].certificateImage) { %>
                                            <a href="<%= certData[i].certificateImage %>" target="_blank"
                                                class="btn btn-sm btn-outline-success btn-block">ðŸ–¼ View Image</a>
                                            <% } else { %>
                                                <span class="btn btn-sm btn-outline-secondary btn-block disabled">No
                                                    Image</span>
                                                <% } %>
                                    </div>
                                    <div class="col-sm-4">
                                        <% if (!certData[i].revoked) { %>
                                            <button class="btn btn-sm btn-outline-danger btn-block" data-toggle="modal"
                                                data-target="#revokeModal" data-certid="<%= certData[i].certUUID %>"
                                                data-name="<%= certData[i].studentName %>">ðŸš« Revoke</button>
                                            <% } else { %>
                                                <span
                                                    class="btn btn-sm btn-outline-secondary btn-block disabled">Revoked</span>
                                                <% } %>
                                    </div>
                                </div>
                    </div>
                </div>
                <% } %>

                    <!-- Revoke Modal -->
                    <div class="modal fade" id="revokeModal" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="revokeModalTitle">Revoke Certificate</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <form action="/university/revoke" method="POST">
                                    <div class="modal-body">
                                        <p>Are you sure you want to revoke the certificate for <strong
                                                id="revokeStudentName"></strong>?</p>
                                        <p class="text-muted small">This action cannot be undone.</p>
                                        <input type="hidden" name="certId" id="revokeCertId">
                                        <div class="form-group">
                                            <label for="revokeReason">Reason for Revocation</label>
                                            <textarea name="reason" class="form-control" id="revokeReason" rows="3"
                                                placeholder="e.g. Fraudulent submission, Academic misconduct..."
                                                required></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-danger">Revoke Certificate</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

        </div>

</body>

</html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
    integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
    integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
    crossorigin="anonymous"></script>
<script>
    $(document).ready(function () {
        // Populate department filter
        var depts = new Set();
        $('.cert-item').each(function () {
            var dept = $(this).data('dept');
            if (dept) depts.add(dept);
        });
        depts.forEach(function (d) {
            $('#filterDept').append('<option value="' + d + '">' + d + '</option>');
        });

        // Search & filter logic
        function applyFilters() {
            var search = $('#searchInput').val().toLowerCase();
            var dept = $('#filterDept').val().toLowerCase();
            var status = $('#filterStatus').val().toLowerCase();
            var visible = 0;

            $('.cert-item').each(function () {
                var name = $(this).data('name').toString().toLowerCase();
                var email = $(this).data('email').toString().toLowerCase();
                var d = $(this).data('dept').toString().toLowerCase();
                var s = $(this).data('status').toString().toLowerCase();

                var matchSearch = !search || name.includes(search) || email.includes(search) || d.includes(search);
                var matchDept = !dept || d === dept;
                var matchStatus = !status || s === status;

                if (matchSearch && matchDept && matchStatus) {
                    $(this).show();
                    visible++;
                } else {
                    $(this).hide();
                }
            });
            $('#visibleCount').text(visible);
        }

        $('#searchInput').on('input', applyFilters);
        $('#filterDept').on('change', applyFilters);
        $('#filterStatus').on('change', applyFilters);

        // Revoke modal population
        $('#revokeModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var certId = button.data('certid');
            var name = button.data('name');
            $('#revokeCertId').val(certId);
            $('#revokeStudentName').text(name);
        });
    });
</script>